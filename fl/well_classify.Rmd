---
title: "Floridan Project--Well Classification"
author: "Annette Hilton"
date: "12/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, error = FALSE)
```

# Introduction

This project is an examination of early 1900s (~1890-1906) groundwater conditions in the Floridan (FL) as compared to present day (2010-2021).

The purpose of this Rmd is to: 

*Pre-Rmd*: Data were processed in ArcGIS for DEM value 

1) Prep data for input to ArcGIS (for hydrogeological analysis) 
2) After ArcGIS processing: 

1) Determine well-aquifer classification 
2) 
  

## Attach Packages and Data 

```{r}
# Attach packages 

library(plyr) # Be sure to load `plyr()` first, otherwise other functions in tidyverse break! 
library(tidyverse)
library(here)
library(janitor)
library(naniar)

# Disable scientific notation 

options(scipen=999)
```

```{r}
# Modern data 
# Read in modern USGS data w/ DEM 
dem_usgs_modern <- readr::read_csv(here::here("data", "dem", "dem_usgs_modern.csv")) 

# Read in modern USGS data full file (from Rmd `modern_data_cleaning.Rmd`)
usgs_modern <- readr::read_tsv(here::here("output_data", "usgs_modern.txt"))

```

### Join DEM files with full data files 

```{r}
# Join modern 

modern_join <- usgs_modern %>% 
  full_join(dem_usgs_modern, by = "site_no")

```

## Data Analysis (Pre-Arc)

### Refine dataset for the Floridan  

```{r}
# Only keep well data for states in FL: 
# Florida, Georgia, Alabama

fl <- modern_join %>% 
  filter(id.x %in% c("al", "fl", "ga", "sc")) 

```


### Prep data for import into ArcGIS 

```{r}
# Write to text file to then export to ArcGIS

write_tsv(fl, here::here("output_data", "fl", "fl_modern_toclassify.txt"))
  
```


## ArcGIS Data Analysis 

The following steps were performed in ArcGIS: 

Hydrogeological data: 
Arcfile = "floridan" 

1. Import USGS FL geologic data (rasters: must convert ASCII txt file to rasters, use "Copy Raster" tool in ArcGIS Pro)
2. Import USGS wells (text file from analysis above; 'fl_modern_toclassify.txt') and early 1900s data (early1900s_dem_wgs84_final.txt)
3. Use tool "Extract multi values to points" to determine well location intersection with geological raster layers
4. Export resulting well data as a text file 

## Data Analysis (Post-Arc)

### Hydrogeological data 

```{r}
# Read in modern data file from Arc 

fl_mod_fromarc <- readr::read_csv(here::here("data", "fl", "fl_modern_hydro.txt"))

# Read in early 1900s data file from Arc 

early1900s_fromarc <- readr::read_csv(here::here("data", "fl", "early1900swells_fl.txt"))

# Read in meta file for early 1900s 

early1900s_meta <- readr::read_tsv(here::here("output_data", "early1900s_arc.txt"))

```

Tidy data 
**Note: ArcGIS somehow messes up data (water level, well depth)--from DEM, only keep the site ID and the DEM value. For 1900s data, join with old file here. 
Modern file already joined above. 

```{r}
# Basic data tidying 
# Create `na_strings` to indicate pesky NA values
# Replace NA numeric indicators with "NA" 
# Rename long column names with their short hydrogeologic formation 

# Modern data

na_strings <- c("-9999", "-9999.00", "-9999.000", "-9999.0000", "-9999.00000", "-9999.000000")

fl_mod_tidy <- fl_mod_fromarc %>% 
  clean_names() %>% 
  select(-oid, -fig45_top_lf_below_lisapcu_r) %>% 
  replace_with_na_all(condition = ~.x %in% na_strings) %>% 
    dplyr::rename(surf_thick = fig20_thickness_surficial_ra, 
                ucu_thick = plate3_thickness_ucu_raster,
                uf_top = plate4_top_fas_raster_copy_ra, 
                buca_top = fig43_top_bucatunna_raster_c,
                buca_bot = fig43_bot_bucatunna_raster_c,
                ocaplpz_top = fig28_top_ocaplpz_raster_cop, 
                appz_top = fig30_top_aggregated_appz_ra, 
                lisapcu_top = fig33_top_lisapcu_raster_cop, 
                lf_top = fig44_top_lf_raster_copy_rast, 
                mapcu_top = fig38_top_mapcu_raster_copy_r, 
                lappz_top = fig46_top_lappz_raster_copy_r, 
                glauc_top = fig48_top_glaucunit_raster_c,
                oldspz_top = fig49_top_oldspz_raster_copy,
                oldspz_bot = fig24_lowreszone_below_oldsp)

# Join with meta file 

fl_mod_join <- fl_mod_tidy %>% 
  full_join(modern_join, by = "site_no") %>% 
  select(-dec_lat_va.x:-x, -RASTERVALU) %>% 
  clean_names()

# 1900s data 

early1900s_tidy <- early1900s_fromarc %>% 
  clean_names() %>% 
  select(-oid, -oid1, -fig45_top_lf_below_lisapcu_r) %>% 
  dplyr::rename(surf_thick = fig20_thickness_surficial_ra, 
                ucu_thick = plate3_thickness_ucu_raster,
                uf_top = plate4_top_fas_raster_copy_ra, 
                buca_top = fig43_top_bucatunna_raster_c,
                buca_bot = fig43_bot_bucatunna_raster_c,
                ocaplpz_top = fig28_top_ocaplpz_raster_cop, 
                appz_top = fig30_top_aggregated_appz_ra, 
                lisapcu_top = fig33_top_lisapcu_raster_cop, 
                lf_top = fig44_top_lf_raster_copy_rast, 
                mapcu_top = fig38_top_mapcu_raster_copy_r, 
                lappz_top = fig46_top_lappz_raster_copy_r, 
                glauc_top = fig48_top_glaucunit_raster_c,
                oldspz_top = fig49_top_oldspz_raster_copy,
                oldspz_bot = fig24_lowreszone_below_oldsp)

# Join with meta file 

early1900s_join <- early1900s_tidy %>% 
  full_join(early1900s_meta, by = "id") %>% 
  clean_names() %>% 
  select(-latitude_x:-artesian_x)

```

### FL Aquifer Information 

Hydrogeologic Layer Surfaces:

- Surficial aquifer (surf) 
- Upper confining unit (UCU) 
- Upper Floridan 
- Bucatunna clay confining unit 
- OCAPLPZ (Ocala-Avon Park lower-permeability zone/semi confining)
- APPZ (Avon Park permeable zone)
- LISAPCU (Confining/semi confining)
- Lower Floridan 
- MAPCU (confining/semi confining)
- LAPPZ (Lower Avon Park permeable zone)
- GLAUCU (Glauconite marker unit/ semi confining) 
- OLDSPZ (Oldsmar permeable zone)

Two areas of units: 

One: 
- SURF 
- UCU 
- UF
- Buca 
- LISAPCU 
- LF 

Two: 
- SURF
- UCU
- UF
- OCAPLPZ
- APPZ
- LISAPCU
- LF
- MAPCU
- LAPPZ
- GLAUC
- OLDSPZ


### Aquifer analysis 

- Find well bottom 
- Remove observations that do not fall within FL (all NAs) 

```{r}
# Convert `rastervalu` column from meters to feet (conversion: 1 meter = 3.28084 feet)
# Add a column that is elevation minus well depth
# Add column to remove rows if surf_thick:oldspz_top are all NAs (does not intersect with FL) 

# Modern data 

fl_analysis_mod <- fl_mod_join %>% 
  mutate(topo_ft = rastervalu * 3.28084) %>% 
  mutate(well_bottom = topo_ft - well_depth_va_y) %>% 
   mutate(keep = 
           ifelse(is.na(surf_thick) & is.na(ucu_thick) & is.na(uf_top) 
                  & is.na(buca_top) & is.na(ocaplpz_top) & is.na(appz_top)
                  & is.na(lisapcu_top) & is.na(lf_top) & is.na(mapcu_top)
                  & is.na(lappz_top) & is.na(glauc_top) & is.na(oldspz_top), "NA", "keep")) %>% 
  filter(!keep == "NA")


# 1900s data 

fl_analysis_1900 <- early1900s_join %>% 
  mutate(topo_ft = ned10m_bilinear_cusa_albers102003 * 3.28084) %>% 
  mutate(well_bottom = topo_ft - well_depth_ft_y) %>% 
   mutate(keep = 
           ifelse(is.na(surf_thick) & is.na(ucu_thick) & is.na(uf_top) 
                  & is.na(buca_top) & is.na(ocaplpz_top) & is.na(appz_top)
                  & is.na(lisapcu_top) & is.na(lf_top) & is.na(mapcu_top)
                  & is.na(lappz_top) & is.na(glauc_top) & is.na(oldspz_top), "NA", "keep")) %>% 
  filter(!keep == "NA")
```

### Extra Step--Calculate top of UCU 

- Only thickness of SURF & UCU provideded (not tops) in original data 
- Correspondance with USGS Jason Bellino (screenshot of email saved in metadata folder) led to method of: 

1. Use Upper Floridan top + UCU thickness = top of UCU 
2. All wells above top of UCU = surficial aquifer 
3. All wells below top of UCU = confined/specific aquifer units 


```{r}
# Modern data 

fl_analysis_mod_2 <- fl_analysis_mod %>% 
  mutate(ucu_top = uf_top + ucu_thick, 
         surf_top = ucu_top + surf_thick) %>% 
  select(site_no, lat, long, well_depth_va_y, median,
         level_date_y, level_year_y, id_x, rastervalu, topo_ft, 
         surf_top, ucu_top, uf_top, buca_top, buca_bot, 
         ocaplpz_top, appz_top, lisapcu_top, mapcu_top, lf_top,
         lappz_top, glauc_top, oldspz_top, oldspz_bot, well_bottom, artesian)

# 1900s data 

fl_analysis_1900_2 <- fl_analysis_1900 %>% 
  mutate(ucu_top = uf_top + ucu_thick, 
         surf_top = ucu_top + surf_thick) %>% 
  select(id, latitude_y, longitude_y, well_depth_ft_y, 
         water_level_ft_y, artesian_y, ned10m_bilinear_cusa_albers102003, 
         topo_ft, surf_top, ucu_top, uf_top, buca_top, buca_bot, 
         ocaplpz_top, appz_top, lisapcu_top, mapcu_top, lf_top,
         lappz_top, glauc_top, oldspz_top, oldspz_bot, well_bottom)

```

#### Classify each well to an aquifer unit 

Process: 

If well bottom is greater than second unit (top), then it falls within the first unit (second unit top is the bottom of the first unit). 

Well bottom < topo_ft & well bottom > max(ucu_top:oldspz_top) = “surf”
Well bottom < ucu_top & well bottom > uf_top = “ucu"
well bottom < buca_top & well bottom > lf_top = "buca" 
well bottom < lisapcu_top & well bottom > lf_top = "lisapcu" 
Well bottom < ocaplpz_top & well bottom > appz_top = “ocaplpz”
well bottom < appz_top & well bottom > mapcu_top = "appz" 
well bottom < mapcu_top & well bottom > lappz_top = "mapcu" 
well bottom < lappz_top & well bottom > glauc_top = "lappz" 
well bottom < glauc_top & well bottom > oldspz_top = "glauc" 
well bottom < oldspz_top & well bottom > 3598 = "oldspz" 

well bottom < uf_top & well bottom > max(buca_top, lisapcu_top, ocaplpz_top) = "upper_fl" 
well bottom < lf_top & lappz_top, glauc_top, oldspz_top is.na = "lower_fl" 


Two areas of units: 

One: 
- SURF 
- UCU 
- UF
- Buca 
- LISAPCU 
- LF 

Two: 
- SURF
- UCU
- UF
- OCAPLPZ
- APPZ
- LISAPCU
- MAPCU
- LF (same ish as LAPPZ where exists)
- LAPPZ
- GLAUC
- OLDSPZ

```{r}
# Code for assigning each well to an aquifer unit 
# Not elegant but currently works! 

# Modern data 

fl_class_mod <- fl_analysis_mod_2 %>% 
  rowwise() %>%
  mutate(aquifer = 
        ifelse(well_bottom < topo_ft & well_bottom >= max(ucu_top, uf_top, buca_top, buca_bot, ocaplpz_top, 
                                                          appz_top, lisapcu_top, lf_top, mapcu_top, 
                                                          lappz_top, glauc_top, oldspz_top, oldspz_bot,
                                                          na.rm = TRUE), "surf", 
        ifelse(well_bottom < ucu_top & well_bottom >= uf_top,"ucu",
        ifelse(well_bottom < uf_top & well_bottom >= max(buca_top, buca_bot, lisapcu_top, ocaplpz_top, appz_top, 
                                                         lf_top, mapcu_top, lappz_top, glauc_top, oldspz_top, 
                                                         oldspz_bot, na.rm = TRUE), "upper_fl", 
        ifelse(well_bottom < buca_top & well_bottom >= max(buca_bot, lisapcu_top, ocaplpz_top, appz_top, lf_top, 
                                                           mapcu_top, lappz_top, glauc_top, oldspz_top, na.rm = TRUE), "buca", 
        ifelse(well_bottom < lisapcu_top & well_bottom >= max(ocaplpz_top, appz_top, lf_top, mapcu_top, lappz_top, 
                                                              glauc_top, oldspz_top, oldspz_bot, na.rm = TRUE),"lisapcu",
        ifelse(well_bottom < ocaplpz_top & well_bottom >= max(appz_top, lf_top, mapcu_top, lappz_top, glauc_top, 
                                                              oldspz_top, oldspz_bot, na.rm = TRUE), "ocaplpz", 
        ifelse(well_bottom < appz_top & well_bottom >= max(lisapcu_top, lf_top, mapcu_top, lappz_top, glauc_top, 
                                                           oldspz_top, oldspz_bot, na.rm = TRUE), "appz", 
        ifelse(well_bottom < mapcu_top & well_bottom >= max(lf_top, lappz_top, glauc_top, oldspz_top, oldspz_bot, 
                                                            na.rm = TRUE), "mapcu",
        ifelse(well_bottom < lf_top & is.na(lappz_top) & is.na(glauc_top) & is.na(oldspz_top) & is.na(oldspz_bot), "lower_fl",
        ifelse(well_bottom < lappz_top & well_bottom >= max(glauc_top, oldspz_top, oldspz_bot, na.rm = TRUE), "lappz",
        ifelse(well_bottom < glauc_top & well_bottom >= max(oldspz_top, oldspz_bot, na.rm = TRUE), "glauc",
        ifelse(well_bottom < oldspz_top & well_bottom > oldspz_bot, "oldspz", NA)))))))))))))


# 1900s data 

fl_class_1900 <- fl_analysis_1900_2 %>% 
  rowwise() %>%
  mutate(aquifer = 
        ifelse(well_bottom < topo_ft & well_bottom >= max(ucu_top, uf_top, buca_top, buca_bot, ocaplpz_top, 
                                                          appz_top, lisapcu_top, lf_top, mapcu_top, 
                                                          lappz_top, glauc_top, oldspz_top, oldspz_bot,
                                                          na.rm = TRUE), "surf", 
        ifelse(well_bottom < ucu_top & well_bottom >= uf_top,"ucu",
        ifelse(well_bottom < uf_top & well_bottom >= max(buca_top, buca_bot, lisapcu_top, ocaplpz_top, appz_top, 
                                                         lf_top, mapcu_top, lappz_top, glauc_top, oldspz_top, 
                                                         oldspz_bot, na.rm = TRUE), "upper_fl", 
        ifelse(well_bottom < buca_top & well_bottom >= max(buca_bot, lisapcu_top, ocaplpz_top, appz_top, lf_top, 
                                                           mapcu_top, lappz_top, glauc_top, oldspz_top, na.rm = TRUE), "buca", 
        ifelse(well_bottom < lisapcu_top & well_bottom >= max(ocaplpz_top, appz_top, lf_top, mapcu_top, lappz_top, 
                                                              glauc_top, oldspz_top, oldspz_bot, na.rm = TRUE),"lisapcu",
        ifelse(well_bottom < ocaplpz_top & well_bottom >= max(appz_top, lf_top, mapcu_top, lappz_top, glauc_top, 
                                                              oldspz_top, oldspz_bot, na.rm = TRUE), "ocaplpz", 
        ifelse(well_bottom < appz_top & well_bottom >= max(lisapcu_top, lf_top, mapcu_top, lappz_top, glauc_top, 
                                                           oldspz_top, oldspz_bot, na.rm = TRUE), "appz", 
        ifelse(well_bottom < mapcu_top & well_bottom >= max(lf_top, lappz_top, glauc_top, oldspz_top, oldspz_bot, 
                                                            na.rm = TRUE), "mapcu",
        ifelse(well_bottom < lf_top & is.na(lappz_top) & is.na(glauc_top) & is.na(oldspz_top) & is.na(oldspz_bot), "lower_fl",
        ifelse(well_bottom < lappz_top & well_bottom >= max(glauc_top, oldspz_top, oldspz_bot, na.rm = TRUE), "lappz",
        ifelse(well_bottom < glauc_top & well_bottom >= max(oldspz_top, oldspz_bot, na.rm = TRUE), "glauc",
        ifelse(well_bottom < oldspz_top & well_bottom > oldspz_bot, "oldspz", NA)))))))))))))
```

```{r}
# everything that is NA/did not get classified 

na_fl <- fl_class_mod %>% 
  filter(is.na(aquifer))

write_tsv(na_fl, "na_fl.txt")
```

Summary of wells per aquifer unit 

```{r}
# Summary of wells per aquifer unit 

# Modern data 
summarymod_fl <- fl_class_mod %>% 
  group_by(aquifer) %>% 
  count(aquifer) 


# 1900s data 

summary1900_fl <- fl_class_1900 %>% 
  group_by(aquifer) %>% 
  count(aquifer)



# join summaries 

full_summary <- summary1900_fl %>% 
  full_join(summarymod_fl, by = "aquifer") %>% 
  rename(historical = n.x, 
         modern = n.y)

write_tsv(full_summary, here::here("output_data", "fl", "full_summary.txt"))

```

#### Confined Well Criteria 

Confined aquifer units (Upper Floridan, APPZ, LAPPZ, OLDSPZ, Lower Floridan): 

- Criteria: Must have at least 10 m (33 ft) of confining material above
- Code: Dependent on the aquifer, calculate the sum of the confining unit thickness above. If the sum of the confining unit thickness is >= 33 ft (10m), then "keep" the well. 

**Note: for this study, units MCUI, OCAPLPZ, MAPCU, LISAPCU, and GLAUCU are all semi-confining. Due to uncertainty, we are removing them from counting toward any confining unit thickness and removing them from the study. 

First, determine thickness of aquifer units 

```{r}
# Thickness of aquifer units 

# Modern data 

fl_thickness_mod <- fl_class_mod %>% 
  mutate(
    ucu_thick = ucu_top - uf_top, 
    buca_thick = buca_top - buca_bot)

# 1900s data 

fl_thickness_1900 <- fl_class_1900 %>% 
  mutate(
    ucu_thick = ucu_top - uf_top, 
    buca_thick = buca_top - buca_bot)

```

Then, determine cumulative thickness & which wells meet criteria 

```{r}
# Only consider confining units for thickness 
# UCU, Bucatunna

# Modern data 

fl_cum_thickness_mod <- fl_thickness_mod %>% 
  rowwise() %>% 
  mutate(cum_thick = 
        ifelse(aquifer == "surf", sum(ucu_thick, buca_thick, na.rm = TRUE), 
        ifelse(aquifer == "upper_fl", sum(ucu_thick), 
        ifelse(aquifer == "appz", sum(ucu_thick),
        ifelse(aquifer == "lappz", sum(ucu_thick), 
        ifelse(aquifer == "oldspz", sum(ucu_thick), 
        ifelse(aquifer == "lower_fl", sum(ucu_thick, buca_thick, na.rm = TRUE),
        NA))))))) %>% 
  mutate(keep = 
           ifelse(cum_thick >= 33, "keep", NA))

# 1900s data

fl_cum_thickness_1900 <- fl_thickness_1900 %>% 
  rowwise() %>% 
  mutate(cum_thick = 
        ifelse(aquifer == "surf", sum(ucu_thick, buca_thick, na.rm = TRUE), 
        ifelse(aquifer == "upper_fl", sum(ucu_thick), 
        ifelse(aquifer == "appz", sum(ucu_thick),
        ifelse(aquifer == "lappz", sum(ucu_thick), 
        ifelse(aquifer == "oldspz", sum(ucu_thick), 
        ifelse(aquifer == "lower_fl", sum(ucu_thick, buca_thick, na.rm = TRUE),
        NA))))))) %>% 
  mutate(keep = 
           ifelse(cum_thick >= 33, "keep", NA))
```


### Separate each aquifer/unit and confined 

Confined aquifers 

Modern n = 880
1900s n = 110

```{r}
# All aquifers that are confined by our criteria  
# Add artesian designation for modern data 
  
# Modern data 
fl_confined_mod <- fl_cum_thickness_mod %>% 
  filter(keep == "keep" & !aquifer == "surf") %>% 
  mutate(artesian = 
           ifelse(median < 0, 1, 0))

# write file for arc 

write_tsv(fl_confined_mod, here::here("output_data", "fl", "modern_confined.txt"))


# 1900s data 

fl_confined_1900 <- fl_cum_thickness_1900 %>% 
  filter(keep == "keep" & !aquifer == "surf")

# write file for arc 

write_tsv(fl_confined_1900, here::here("output_data", "fl", "historical_confined.txt"))

```


#### Comparison of artesian conditions 

UF (Upper Floridan Aquifer) 1900 to 2010-2020 

Modern n = 87
1900s n = 1137

```{r}
# Separate UF units 

# Modern 
modern_uf <- fl_class_mod %>% 
  filter(aquifer == "upper_fl") %>% 
  mutate(artesian = 
           ifelse(lev_va < 0, 1, 0))

# write file for arc 

write_tsv(modern_uf, here::here("output_data", "fl", "modern_uf.txt"))

# 1900s 
historical_uf <- fl_class_1900 %>% 
  filter(aquifer == "upper_fl")

# write file for arc 

write_tsv(historical_uf, here::here("output_data", "fl", "historical_uf.txt"))

```


