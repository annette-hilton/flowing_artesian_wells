---
title: "Floridan Project--Well Classification"
author: "Annette Hilton"
date: "05/27/2022"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, error = FALSE)
```

# Introduction

This project is an examination of early 1900s (~1890-1906) groundwater conditions in the Floridan Aquifer System (FL) as compared to present day (2010-2021).

The purpose of this Rmd is to:

1)  Determine well-aquifer classification
2)  Compare artesian conditions
  

## Attach Packages and Data 

```{r}
# Attach packages 

# library(plyr) # Be sure to load `plyr()` first, otherwise other functions in tidyverse break! 
library(tidyverse)
library(here)
library(janitor)
library(naniar)
library(data.table)
library(knitr)

# Disable scientific notation 

options(scipen=999)
```

# Overview of the Floridan Aquifer System 

```{r, fig.cap= 'Figure 1. Floridan Aquifer System aerial extent (Williams and Kuniansky, 2015)', fig.align='center', output.width= "200px", echo= FALSE}

knitr::include_graphics(here::here("images", "fl_aerial.png"))

```


```{r, fig.cap= 'Figure 2. Floridan Aquifer System cross section view (Williams and Kuniansky, 2015)', fig.align='center', output.width= "200px", echo= FALSE}

knitr::include_graphics(here::here("images", "fl_hydro.png"))

```



```{r, fig.cap= 'Figure 3. Floridan Aquifer System hydrological units (Williams and Kuniansky, 2015)', fig.align='center', output.width= "200px", echo= FALSE}

knitr::include_graphics(here::here("images", "fl_hydro2.png"))

```


## ArcGIS Data Analysis 

The following steps were performed in ArcGIS:

Hydrogeological data: Arcfile = "fl_classify" (ArcPro)

1.  Hydrogeologic layers (raster files)
2.  Modern wells from FL (USGS) (processed in Rmd
    `modern_data_cleaning.Rmd`) and early 1900s data
    (early1900s_dem_wgs84_final.txt)
3.  Use tool "Extract multi values to points" to determine well location
    intersection with geological raster layers
4.  Export resulting well data as a text files


### Hydrogeological data 

```{r}
# Read in modern data file from Arc 
# Rename raster files to hydrogeologic units

fl_mod_fromarc <- readr::read_csv(here::here("data", "fl", "fl_mod_classify_052722.txt")) %>% 
  clean_names() %>% 
  select(-oid, -fig45_top_lf_below_lisapcu_r) %>% 
  dplyr::rename(surf_thick = fig20_thickness_surficial_ra, 
                ucu_thick = plate3_thickness_ucu_raster,
                uf_top = plate4_top_fas_raster_copy_ra, 
                buca_top = fig43_top_bucatunna_raster_c,
                buca_bot = fig43_bot_bucatunna_raster_c,
                ocaplpz_top = fig28_top_ocaplpz_raster_cop, 
                appz_top = fig30_top_aggregated_appz_ra, 
                lisapcu_top = fig33_top_lisapcu_raster_cop, 
                lf_top = fig44_top_lf_raster_copy_rast, 
                mapcu_top = fig38_top_mapcu_raster_copy_r, 
                lappz_top = fig46_top_lappz_raster_copy_r, 
                glauc_top = fig48_top_glaucunit_raster_c,
                oldspz_top = fig49_top_oldspz_raster_copy,
                oldspz_bot = fig24_lowreszone_below_oldsp)

# Read in early 1900s data file from Arc 
# Rename raster files to hydrogeologic units

early1900s_fromarc <- readr::read_csv(here::here("data", "fl", "fl_historical_classify.txt")) %>% 
  clean_names() %>% 
  select(-oid, -fig45_top_lf_below_lisapcu_r) %>% 
  dplyr::rename(surf_thick = fig20_thickness_surficial_ra, 
                ucu_thick = plate3_thickness_ucu_raster,
                uf_top = plate4_top_fas_raster_copy_ra, 
                buca_top = fig43_top_bucatunna_raster_c,
                buca_bot = fig43_bot_bucatunna_raster_c,
                ocaplpz_top = fig28_top_ocaplpz_raster_cop, 
                appz_top = fig30_top_aggregated_appz_ra, 
                lisapcu_top = fig33_top_lisapcu_raster_cop, 
                lf_top = fig44_top_lf_raster_copy_rast, 
                mapcu_top = fig38_top_mapcu_raster_copy_r, 
                lappz_top = fig46_top_lappz_raster_copy_r, 
                glauc_top = fig48_top_glaucunit_raster_c,
                oldspz_top = fig49_top_oldspz_raster_copy,
                oldspz_bot = fig24_lowreszone_below_oldsp)

```
### FL Aquifer Information 

Hydrogeologic Layer Surfaces:

- Surficial aquifer (surf) 
- Upper confining unit (UCU) 
- Upper Floridan 
- Bucatunna clay confining unit 
- OCAPLPZ (Ocala-Avon Park lower-permeability zone/semi confining)
- APPZ (Avon Park permeable zone)
- LISAPCU (Confining/semi confining)
- Lower Floridan 
- MAPCU (confining/semi confining)
- LAPPZ (Lower Avon Park permeable zone)
- GLAUCU (Glauconite marker unit/ semi confining) 
- OLDSPZ (Oldsmar permeable zone)

Two areas of units: 

One:   
- SURF  
- UCU   
- UF  
- Buca   
- LISAPCU   
- LF   

Two:   
- SURF  
- UCU  
- UF  
- OCAPLPZ  
- APPZ  
- LISAPCU  
- LF  
- MAPCU  
- LAPPZ  
- GLAUC  
- OLDSPZ  


### Aquifer analysis 

- Find well bottom 
- Remove observations that do not fall within FL (all NAs) 

```{r}
# Convert `rastervalu` column from meters to feet (conversion: 1 meter = 3.28084 feet)
# Add a column that is elevation minus well depth
# Add column to remove rows if surf_thick:oldspz_top are all NAs (does not intersect with FL) 

# Modern data 

na_strings <- c("-9999", "-9999.00", "-9999.000", "-9999.0000", "-9999.00000", "-9999.000000")

fl_analysis_mod <- fl_mod_fromarc %>% 
  replace_with_na_all(condition = ~.x %in% na_strings) %>% 
  mutate(topo_ft = rastervalu * 3.28084) %>% 
  mutate(well_bottom = topo_ft - well_depth_va) %>% 
   mutate(keep = 
           ifelse(is.na(surf_thick) & is.na(ucu_thick) & is.na(uf_top) 
                  & is.na(buca_top) & is.na(ocaplpz_top) & is.na(appz_top)
                  & is.na(lisapcu_top) & is.na(lf_top) & is.na(mapcu_top)
                  & is.na(lappz_top) & is.na(glauc_top) & is.na(oldspz_top), "NA", "keep")) %>% 
  filter(!keep == "NA")


# 1900s data 

fl_analysis_1900 <- early1900s_fromarc %>% 
  mutate(topo_ft = ned10m_bilinear_cusa_albers102003 * 3.28084) %>% 
  mutate(well_bottom = topo_ft - well_depth_ft) %>% 
   mutate(keep = 
           ifelse(is.na(surf_thick) & is.na(ucu_thick) & is.na(uf_top) 
                  & is.na(buca_top) & is.na(ocaplpz_top) & is.na(appz_top)
                  & is.na(lisapcu_top) & is.na(lf_top) & is.na(mapcu_top)
                  & is.na(lappz_top) & is.na(glauc_top) & is.na(oldspz_top), "NA", "keep")) %>% 
  filter(!keep == "NA")

```

### Extra Step--Calculate top of UCU 

- Only thickness of SURF & UCU provideded (not tops) in original data 
- Correspondance with USGS Jason Bellino (screenshot of email saved in metadata folder) led to method of: 

1. Use Upper Floridan top + UCU thickness = top of UCU 
2. All wells above top of UCU = surficial aquifer 
3. All wells below top of UCU = confined/specific aquifer units   


```{r}
# Modern data 

fl_analysis_mod_2 <- fl_analysis_mod %>% 
  mutate(ucu_top = uf_top + ucu_thick, 
         surf_top = ucu_top + surf_thick)

# 1900s data 

fl_analysis_1900_2 <- fl_analysis_1900 %>% 
  mutate(ucu_top = uf_top + ucu_thick, 
         surf_top = ucu_top + surf_thick)

```

#### Classify each well to an aquifer unit 

Process: 

If well bottom is greater than second unit (top), then it falls within the first unit (second unit top is the bottom of the first unit). 

Well bottom < topo_ft & well bottom > max(ucu_top:oldspz_top) = “surf”  
Well bottom < ucu_top & well bottom > uf_top = “ucu"  
well bottom < buca_top & well bottom > lf_top = "buca"   
well bottom < lisapcu_top & well bottom > lf_top = "lisapcu"   
Well bottom < ocaplpz_top & well bottom > appz_top = “ocaplpz”  
well bottom < appz_top & well bottom > mapcu_top = "appz"   
well bottom < mapcu_top & well bottom > lappz_top = "mapcu"   
well bottom < lappz_top & well bottom > glauc_top = "lappz"   
well bottom < glauc_top & well bottom > oldspz_top = "glauc"   
well bottom < oldspz_top & well bottom > 3598 = "oldspz"   

well bottom < uf_top & well bottom > max(buca_top, lisapcu_top, ocaplpz_top) = "upper_fl"   
well bottom < lf_top & lappz_top, glauc_top, oldspz_top is.na = "lower_fl"   


Two areas of units: 

One: 
- SURF 
- UCU 
- UF
- Buca 
- LISAPCU 
- LF 

Two: 
- SURF
- UCU
- UF
- OCAPLPZ
- APPZ
- LISAPCU
- MAPCU
- LF (same ish as LAPPZ where exists)
- LAPPZ
- GLAUC
- OLDSPZ


##### Modern Data 

```{r}
# Code for assigning each well to an aquifer unit 
# Not elegant but currently works! 

# Modern data 

fl_class_mod <- fl_analysis_mod_2 %>% 
  rowwise() %>%
  mutate(aquifer = 
        ifelse(well_bottom < topo_ft & well_bottom >= max(ucu_top, uf_top, buca_top, buca_bot, ocaplpz_top, 
                                                          appz_top, lisapcu_top, lf_top, mapcu_top, 
                                                          lappz_top, glauc_top, oldspz_top, oldspz_bot,
                                                          na.rm = TRUE), "surf", 
        ifelse(well_bottom < ucu_top & well_bottom >= uf_top,"ucu",
        ifelse(well_bottom < uf_top & well_bottom >= max(buca_top, buca_bot, lisapcu_top, ocaplpz_top, appz_top, 
                                                         lf_top, mapcu_top, lappz_top, glauc_top, oldspz_top, 
                                                         oldspz_bot, na.rm = TRUE), "upper_fl", 
        ifelse(well_bottom < buca_top & well_bottom >= max(buca_bot, lisapcu_top, ocaplpz_top, appz_top, lf_top, 
                                                           mapcu_top, lappz_top, glauc_top, oldspz_top, na.rm = TRUE), "buca", 
        ifelse(well_bottom < lisapcu_top & well_bottom >= max(ocaplpz_top, appz_top, lf_top, mapcu_top, lappz_top, 
                                                              glauc_top, oldspz_top, oldspz_bot, na.rm = TRUE),"lisapcu",
        ifelse(well_bottom < ocaplpz_top & well_bottom >= max(appz_top, lf_top, mapcu_top, lappz_top, glauc_top, 
                                                              oldspz_top, oldspz_bot, na.rm = TRUE), "ocaplpz", 
        ifelse(well_bottom < appz_top & well_bottom >= max(lisapcu_top, lf_top, mapcu_top, lappz_top, glauc_top, 
                                                           oldspz_top, oldspz_bot, na.rm = TRUE), "appz", 
        ifelse(well_bottom < mapcu_top & well_bottom >= max(lf_top, lappz_top, glauc_top, oldspz_top, oldspz_bot, 
                                                            na.rm = TRUE), "mapcu",
        ifelse(well_bottom < lf_top & is.na(lappz_top) & is.na(glauc_top) & is.na(oldspz_top) & is.na(oldspz_bot), "lower_fl",
        ifelse(well_bottom < lappz_top & well_bottom >= max(glauc_top, oldspz_top, oldspz_bot, na.rm = TRUE), "lappz",
        ifelse(well_bottom < glauc_top & well_bottom >= max(oldspz_top, oldspz_bot, na.rm = TRUE), "glauc",
        ifelse(well_bottom < oldspz_top & well_bottom > oldspz_bot, "oldspz", NA)))))))))))))

```

##### 1900s Data 

```{r}
# 1900s data 

fl_class_1900 <- fl_analysis_1900_2 %>% 
  rowwise() %>%
  mutate(aquifer = 
        ifelse(well_bottom < topo_ft & well_bottom >= max(ucu_top, uf_top, buca_top, buca_bot, ocaplpz_top, 
                                                          appz_top, lisapcu_top, lf_top, mapcu_top, 
                                                          lappz_top, glauc_top, oldspz_top, oldspz_bot,
                                                          na.rm = TRUE), "surf", 
        ifelse(well_bottom < ucu_top & well_bottom >= uf_top,"ucu",
        ifelse(well_bottom < uf_top & well_bottom >= max(buca_top, buca_bot, lisapcu_top, ocaplpz_top, appz_top, 
                                                         lf_top, mapcu_top, lappz_top, glauc_top, oldspz_top, 
                                                         oldspz_bot, na.rm = TRUE), "upper_fl", 
        ifelse(well_bottom < buca_top & well_bottom >= max(buca_bot, lisapcu_top, ocaplpz_top, appz_top, lf_top, 
                                                           mapcu_top, lappz_top, glauc_top, oldspz_top, na.rm = TRUE), "buca", 
        ifelse(well_bottom < lisapcu_top & well_bottom >= max(ocaplpz_top, appz_top, lf_top, mapcu_top, lappz_top, 
                                                              glauc_top, oldspz_top, oldspz_bot, na.rm = TRUE),"lisapcu",
        ifelse(well_bottom < ocaplpz_top & well_bottom >= max(appz_top, lf_top, mapcu_top, lappz_top, glauc_top, 
                                                              oldspz_top, oldspz_bot, na.rm = TRUE), "ocaplpz", 
        ifelse(well_bottom < appz_top & well_bottom >= max(lisapcu_top, lf_top, mapcu_top, lappz_top, glauc_top, 
                                                           oldspz_top, oldspz_bot, na.rm = TRUE), "appz", 
        ifelse(well_bottom < mapcu_top & well_bottom >= max(lf_top, lappz_top, glauc_top, oldspz_top, oldspz_bot, 
                                                            na.rm = TRUE), "mapcu",
        ifelse(well_bottom < lf_top & is.na(lappz_top) & is.na(glauc_top) & is.na(oldspz_top) & is.na(oldspz_bot), "lower_fl",
        ifelse(well_bottom < lappz_top & well_bottom >= max(glauc_top, oldspz_top, oldspz_bot, na.rm = TRUE), "lappz",
        ifelse(well_bottom < glauc_top & well_bottom >= max(oldspz_top, oldspz_bot, na.rm = TRUE), "glauc",
        ifelse(well_bottom < oldspz_top & well_bottom > oldspz_bot, "oldspz", NA)))))))))))))
```

### Separate each aquifer/unit and confined

Confining unit must be above (UCU, BUCA) 

Confined units (theoretically): Upper Floridan, APPZ, LAPPZ, OLDSPZ, Lower Floridan, MCUI, OCAPLPZ, LISAPCU, GLAUCU 

Unconfined units (theoretically): Surficial, UCU/BUCA 

**Note: for this study, units MCUI, OCAPLPZ, MAPCU, LISAPCU, and GLAUCU are all semi-confining. Due to uncertainty, we are removing them from counting toward any confining unit thickness  


#### Modern Data

```{r}
# Confining unit criteria 
# Must have confining unit above to be considered a confined well 
# Can include confining units (except the uppermost) 

confined_criteria_mod <- fl_class_mod %>% 
  rowwise() %>% 
  mutate(status = 
           ifelse(is.na(aquifer), NA,
           ifelse(aquifer %in% c("surf", "ucu"), "unconfined", 
           ifelse(aquifer == "buca" & !is.na(ucu_top), "confined",
           ifelse(aquifer == "upper_fl" & (!is.na(ucu_top) | !is.na(buca_top)), "confined",
           ifelse(aquifer %in% c("appz", "ocaplpz", "mapcu", "glauc", "lappz", "lisapcu", "lower_fl", "oldspz") & (!is.na(ucu_top) | !is.na(buca_top)), "confined", 
                  "unconfined"))))))

summary_mod <- confined_criteria_mod %>% 
  count(status)
```

#### 1900 Data

```{r}
# Confining unit criteria 
# Must have confining unit above to be considered a confined well 
# Can include confining units (except the uppermost) 

confined_criteria_1900 <- fl_class_1900 %>% 
  rowwise() %>% 
  mutate(status = 
           ifelse(is.na(aquifer), NA,
           ifelse(aquifer %in% c("surf", "ucu"), "unconfined", 
           ifelse(aquifer == "buca" & !is.na(ucu_top), "confined",
           ifelse(aquifer == "upper_fl" & (!is.na(ucu_top) | !is.na(buca_top)), "confined",
           ifelse(aquifer %in% c("appz", "ocaplpz", "mapcu", "glauc", "lappz", "lisapcu", "lower_fl", "oldspz") & (!is.na(ucu_top) | !is.na(buca_top)), "confined", 
                  "unconfined"))))))

summary_1900 <- confined_criteria_1900 %>% 
  count(status)

```

### Accuracy check with USGS Confined/Unconfined 

#### Modern data only 

```{r}
# Check to see accuracy of confined/unconfined 

fl_modern_check <- confined_criteria_mod %>% 
  rowwise() %>% 
  mutate(check =
           ifelse(status == "confined" & code %in% c("Confined single aquifer", "Confined multiple aquifers"), "true_c", 
           ifelse(status == "confined" & is.na(code), "no_data_c", 
           ifelse(status == "confined" & code %in% c("Unconfined single aquifer", "Unconfined multiple aquifer"), "wrong_c", 
           ifelse(status == "unconfined" & is.na(code), "no_data_uc",
           ifelse(status == "unconfined" & code %in% c("Unconfined single aquifer", "Unconfined multiple aquifer"), "true_uc", 
           ifelse(status == "unconfined" & code %in% c("Confined single aquifer", "Confined multiple aquifers"), "wrong_uc", 
            NA)))))))

# Summary 
summary_check <- fl_modern_check %>% 
  group_by(check) %>% 
  count(check)

# Checked wrong data spatial spread in ArcGIS (commented out)

# # Isolate wrong confined 
# 
# confined_wrong <- nacp_modern_check %>%
#   filter(check == "wrong_c")
# 
# write_tsv(confined_wrong, here::here("output_data", "nacp", "confined_wrong.txt"))

```

Make table from summary of error/unconfined-confined checking --working on this, not complete 05/02/22

```{r}
error_table <- summary_check %>% 
  filter(!is.na(check)) %>%
  mutate(total_n = colSums(summary_check[,-1])) 

```

### Make summary tables 

To count confined, unconfined, artesian by aquifer unit 

Make nice final table

#### Modern Data 

```{r}
# Final summaries of "correct" data 

# Modern data

# Confined/unconfined and artesian by aquifer unit

summary_mod_final_art <- fl_modern_check %>% 
  filter(!check %in% c("wrong_uc", "wrong_c")) %>% 
  group_by(aquifer, status, artesian) %>% 
  count(aquifer) %>% 
  filter(!is.na(status))

# Pivot wider 

mod_final_wide <- pivot_wider(summary_mod_final_art, 
                          names_from = c(status, artesian), 
                          values_from = n) %>% 
  mutate(total_n = rowSums(across(where(is.numeric)), na.rm = T)) %>% 
  mutate(total_c = rowSums(across(confined_0:confined_1), na.rm = T)) %>% 
  rowwise() %>% 
  mutate(per_c = (total_c / total_n) *100) %>% 
  mutate(per_art = (confined_1 / total_c) *100)

# Tidy the table 

mod_final_table <- mod_final_wide %>% 
  select(aquifer, total_n, total_c, per_c, confined_1, per_art, confined_0) %>% 
  replace(is.na(.), 0) %>% 
  mutate_if(is.numeric, round, digits = 2) %>% 
  unite(confined_wells, c("total_c", "per_c"), sep = "  |  ") %>% 
  unite(artesian_wells, c("confined_1", "per_art"), sep = "  |  ") %>% 
  rename("Aquifer Units" = "aquifer", 
         "N wells" = "total_n", 
         "Number of wells defined as confined" = "confined_wells", 
         "Artesian confined flowing wells" = "artesian_wells",
         "Not artesian" = "confined_0") 


# Write to file 
write_csv(mod_final_table, here::here("output_data", "fl", "mod_final_table.txt"))
  
```

```{r echo = FALSE, results = 'asis'}

# Display knitted table 

kable(mod_final_table, caption = "Table 1. Modern (2010-2021) confined and artesian wells of the Floridan Aquifer System")
```

#### 1900s Data 

```{r}
# 1900s data

# Confined/unconfined by aquifer unit 
summary_1900_final <- confined_criteria_1900 %>% 
  group_by(aquifer, status, artesian) %>% 
  count(aquifer) %>% 
  filter(!is.na(aquifer))

# Pivot wider 

early1900s_final_wide <- pivot_wider(summary_1900_final, 
                          names_from = c(status, artesian), 
                          values_from = n) %>% 
  mutate(total_n = rowSums(across(where(is.numeric)), na.rm = T)) %>% 
  rowwise() %>% 
  mutate(total_c = sum(c(confined_0, confined_1), na.rm = T)) %>% 
  mutate(per_c = (total_c / total_n) *100) %>% 
  mutate(per_art = (confined_1 / total_c) *100)

# Tidy the table 

early1900s_final_table <- early1900s_final_wide %>% 
  select(aquifer, total_n, total_c, per_c, confined_1, per_art, confined_0) %>% 
  replace(is.na(.), 0) %>% 
  mutate_if(is.numeric, round, digits = 2) %>% 
  unite(confined_wells, c("total_c", "per_c"), sep = "  |  ") %>% 
  unite(artesian_wells, c("confined_1", "per_art"), sep = "  |  ") %>% 
  rename("Aquifer Units" = "aquifer", 
         "N wells" = "total_n", 
         "Number of wells defined as confined" = "confined_wells", 
         "Artesian confined flowing wells" = "artesian_wells",
         "Not artesian" = "confined_0") 

# Write to file 
write_csv(early1900s_final_table, here::here("output_data", "fl", "early1900s_final_table.txt"))

```

```{r echo = FALSE, results = 'asis'}

# Display knitted table 

kable(early1900s_final_table, caption = "Table 2. Early 1900s confined and artesian wells of the Floridan Aquifer System")
```

### Visualization 

Confined and unconfined well depth 


```{r}
# Data frame for plots 
ggplot_modern <- fl_modern_check %>% 
  filter(!check %in% c("wrong_c", "wrong_uc")) %>% 
  filter(!is.na(check))

# Violin plot comparing confined, unconfined and USGS data/no data 
ggplot(ggplot_modern, 
       aes(x = status, 
           y = well_depth_va, 
           fill = check)) + 
  geom_violin()

```

#### Comparison of artesian conditions (confined wells only) 

1900 to 2010-2020


```{r}
# All aquifers that are confined by our criteria, excluding "incorrect" ones (Modern) with USGS correction 

# Modern wells 
fl_confined_mod <- fl_modern_check %>% 
  filter(check %in% c("true_c", "no_data_c")) %>% 
  mutate(artesian = 
           ifelse(median < 0, 1, 0))

# Write as tsv 
write_csv(fl_confined_mod, here::here("output_data", "fl", "fl_confined_mod.txt"))

# 1900 data 
fl_confined_1900 <- confined_criteria_1900 %>% 
  filter(status == "confined") 

# Write as tsv 
write_csv(fl_confined_1900, here::here("output_data", "fl", "fl_confined_historical.txt"))

```


Final summary table of artesian conditions (percentage of flowing artesian wells) 

```{r}
# Modern 
mod_art <- fl_confined_mod %>% 
  count(artesian) 


# Historical 
hist_art <- fl_confined_1900 %>% 
  count(artesian)
```

