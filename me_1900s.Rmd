---
title: "ME Early 1900s"
author: "Annette Hilton"
date: "11/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Attach Packages

```{r}
# Attach packages 

library(tidyverse)
library(here)
library(janitor)
library(purrr)
library(broom)
library(tibble)
library(dplyr)
library(tidyr)
library(ggpubr)

# Disable scientific notation 

options(scipen=999)
```


## Early 1900s CV Wells  

Methods: 

1. Early 1900s CV wells data: manually compiled by Jasechko lab, 2021 (June-October) 
  - Darton, 1905
  - Fuller, 1905
  - Fuller, 1906
  - Crider & Johnson, 1906
  - Veatch, 1906 

2. Data (above) cleaned in "me_1900s_cleaning.Rmd"

3. Exported into ArcGIS; wells intersected/clipped to ME boundaries 

4. Fishnet created (roughly 10 km by 10 km squares) for entire USA 

5. Spatial join between drilling wells and fishnet (target features = )

6. Import into R for data wrangling 

7. Data cleaning & tidying, prepare for statistical tests 

8. Spearman rank correlations 


## Import Data 

### Methods step 4. 

```{r}
# Read in dataset of spatial join between PLSS shapefile and Mendenhall wells 

plss_mendenhall <- readr::read_csv(here::here("source_data", "plss_mendenhall.txt"))

```

## Data cleaning, tidy, prepare for stats 

### Methods step 5. 

Tidy data, 2010-2020 

```{r}
# Remove wells that have zero depth 

plss_wells_clean <- plss_mendenhall %>% 
  clean_names() %>% 
  filter(!well_depth == 0) 

```

Add criteria: 

1. Each township must have at least 3 wells 
 

```{r}
# 1. Criteria of 3 wells per township 
# Add number column 

 wells_n <- plss_wells_clean %>% 
  group_by(township_ra) %>% 
  filter(n() >= 3) %>% 
  ungroup()

```


2. If more than 50% of the wells in each township are artesian, remove and save for another analysis 

```{r}
# Make a new column for artesian wells (if static water level = 0) 
wells_artesian <- wells_n %>%
  mutate(artesian = 
           case_when(water_dept == 0 ~"1"))
```


```{r}
# Group by township
# Add counts for total number of wells in township
# Add counts for total number of artesian wells in each township 
# Add percentage of artesian wells per township 

wells_total_n <- wells_artesian %>% 
  group_by(township_ra) %>% 
  add_count(township_ra) %>% 
  add_tally(!is.na(artesian), name = "art_n") %>% 
  mutate(percent = (art_n/n))

# Add criteria of 50% or greater artesian are removed 

no_artesian <- wells_total_n %>% 
  group_by(township_ra) %>% 
  filter(!percent > 0.5)

# Keep all artesian well townships 

all_artesian <- wells_total_n %>% 
  group_by(township_ra) %>% 
  filter(percent > 0.5)

# Write artesian file for Arc 

artesian_arc <- all_artesian %>% 
  mutate(arc_artesian = "artesian") %>% 
  select(township_ra, arc_artesian) %>% 
  distinct(township_ra, .keep_all = TRUE)

write_csv(artesian_arc, here::here("output_data", "artesian_arc_1900s.txt"))

```


3. There must be a 10 m (32.8084 ft) difference between the most shallow well and the deepest well in each township (for non-artesian townships)

```{r}
# Well depth vertical offset 

depth_offset <- no_artesian %>% 
  mutate(min_bottom = min(well_depth), 
         max_bottom = max(well_depth)) %>% 
  filter(min_bottom <= max_bottom - 32.8084)

```

## Statistical tests 

### Methods step 6. 

Spearman rank correlation method calculates the correlation between the ranks of x and the ranks of y variables. 

Variable: Depth of well (well_depth)
Variable: Water level (water_dept)

```{r}
# Use lapply() and split() to split the dataframe by "township_ra" and then iterate the cor.test function for each township 

spearman_1900s <- lapply(
  split(depth_offset, depth_offset$township_ra), 
  function(depth_offset) cor.test(
    depth_offset$water_dept, depth_offset$well_depth, method = "spearman"))

# Bind results together in a dataframe and indicate the id (rownames_to_column())

results_1900s <- as.data.frame(do.call(rbind, spearman_1900s)) %>% 
  rownames_to_column(var = "township_ra") %>% 
  select(township_ra, p.value, estimate)

# Remove character string in estimate column (rho)
# Make sure p-value is numeric 

results_1900s$estimate <- gsub("[a-z = ()]", "", results_1900s$estimate)
results_1900s$p.value <- as.numeric(results_1900s$p.value)

# Write as csv 

write_csv(results_1900s, here::here("output_data", "spear_1900s.txt"))

```

## Graph 

Graph all townships 1900s

```{r}

# Join results of spearman ranks with full dataset 

full_data <- depth_offset %>% 
  inner_join(results_1900s, by = "township_ra")


# Use group_split() to indicate separation by townshipra

plot_1900s <- full_data %>%
  group_split(township_ra)

# Make a function to call each ID as the title of the graph

plots <- function(data){

  plot_name <- data$estimate[1]

ggplot(data, aes(x = well_depth, y = water_dept)) +
  geom_point() +
  labs(x = "Depth (ft)",
       y = "Static Water Level (ft)",
       title = plot_name)
}


all_plots <- purrr::map(plot_1900s, plots)

all_plots[[1]]

# Save as PDF

pdf(here::here("output_data", paste0("1900s_spear_", Sys.Date(), ".pdf")), height = 11, width = 8.5)
ggarrange(plotlist = all_plots, ncol = 1, nrow = 3, align = "v")
dev.off()
```


