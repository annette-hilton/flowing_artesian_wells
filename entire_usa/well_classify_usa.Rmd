---
title: "Entire USA--Artesian Comparison"
author: "Annette Hilton"
date: "06/07/2022"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, error = FALSE)
```

# Introduction

This project is an examination of early 1900s (~1890-1906) groundwater conditions in the continental USA as compared to present day (2010-2021).

The purpose of this Rmd is to: 

1) Determine well-aquifer classification 
2) Compare artesian conditions 
  

## Attach Packages and Data 

```{r}
# Attach packages 

library(plyr) # Be sure to load `plyr()` first, otherwise other functions in tidyverse break! 
library(tidyverse)
library(here)
library(janitor)
library(naniar)
library(knitr)

# Disable scientific notation 

options(scipen=999)
```

# Depth to Confined Investigations 

1. Spatial join modern data (`modern_final.txt` from `modern_data_cleaning.Rmd`) with aquifer file and depth data: processsed in ArcPro (file name:`2022_05_16_AquifersWithDepthConfined` ) 
2. Load into R for analysis 
3. Analyze and determine artesian vs non artesian 
4. Map in ArcPro 

```{r}
# Step 2. 
# Modern data 

modern_depths <- readr::read_csv(here::here("data", "depths", "modern_depths_060722_final.txt"))

# 1900s data 
early1900s_depths <- readr::read_csv(here::here("data", "depths", "early1900s_depths.txt"))

```

```{r}
# How many wells do we have for each aquifer system that is greater than the confined depth cut off? 

modern_analysis_depth <- modern_depths %>% 
  mutate(depth_m = well_depth_va * 0.3048) %>% 
  mutate(confined_depth = ifelse(depth_m >= DepthConfi, "confined depth", NA))

modern_depth_final <- modern_analysis_depth %>% 
  filter(!is.na(confined_depth)) %>% 
  group_by(Aquifer_1) %>% 
  filter(n() >= 4)

write_tsv(modern_depth_final, here::here("data", "depths", "modern_depth_final.txt"))
```


```{r}
# How many wells do we have for each aquifer system that is greater than the confined depth cut off? 

historical_analysis_depth <- early1900s_depths %>% 
  mutate(depth_m = well_depth * 0.3048) %>% 
  mutate(confined_depth = ifelse(depth_m >= DepthConfi, "confined depth", NA))

historical_depth_final <- historical_analysis_depth %>% 
  filter(!is.na(confined_depth)) %>% 
  group_by(Aquifer_1) %>% 
  filter(n() >= 4)

write_tsv(historical_depth_final, here::here("data", "depths", "historical_depth_final.txt"))
```

How many aquifers? 

```{r}
# Modern data 
aquifer_modern <- modern_depth_final %>% 
  distinct(Aquifer_1, .keep_all = T)

# 1900 data 
aquifer_historical <- historical_depth_final %>% 
  distinct(Aquifer_1, .keep_all = T)

```

Join modern and historical data 

```{r}
both_hist_modern <- aquifer_modern %>% 
  inner_join(aquifer_historical, by = "Aquifer_1")

write_tsv(both_hist_modern, here::here("data", "depths", "both_aquiferstimeperiod.txt"))
```

### Accuracy check with USGS Confined/Unconfined 

#### Modern data only 


```{r}
# Check to see accuracy of confined/unconfined

modern_check <- modern_depth_final %>%
  rowwise() %>%
  mutate(check =
           ifelse(confined_depth == "confined depth" & code %in% c("Confined single aquifer", "Confined multiple aquifers"), "true_c",
           ifelse(confined_depth == "confined depth" & is.na(code), "no_data_c",
           ifelse(confined_depth == "confined depth" & code %in% c("Unconfined single aquifer", "Unconfined multiple aquifer"), "wrong_c", NA))))

# Summary
summary_check <- modern_check %>%
  group_by(check) %>%
  count(check)

```

#### Artesian Calculations 

Only use data where 1900s and modern overlap in aquifer systems (n = 61) 

```{r}
# Make vector of shared aquifer systems 

shared_aquifers <- both_hist_modern %>% 
  pull(Aquifer_1)

# Use the resulting vector to filter target sites from modern and 1900 data frames 

# Modern 
modern_constrained <- modern_check %>%
  filter(Aquifer_1 %in% c(shared_aquifers)) %>% 
  filter(!check == "wrong_c")

# Quick summary of artesian total 

art_summary_mod <- modern_constrained %>% 
  group_by(artesian) %>% 
  count(artesian)

# Historical 
historical_constrained <- historical_depth_final %>%
  filter(Aquifer_1 %in% c(shared_aquifers))

# Quick summary of artesian total 

art_summary_1900 <- historical_constrained %>% 
  group_by(artesian) %>% 
  count(artesian)
```

```{r}
# Test for dakota 

dakota <-  modern_constrained %>% 
  filter(Aquifer_1 %in% c("Dakota Aquifer System", "Eastern Dakota Aquifer")) 

dak_hist <- hist(dakota$depth_m)
```

Write files to tsv 

```{r}
# Modern
write_tsv(modern_constrained, here::here("output_data", "depths", "modern_usa_confined.txt"))

# 1900s
write_tsv(historical_constrained, here::here("output_data", "depths", "historical_usa_confined.txt"))
```

### Summary tables 

##### Modern Data 

```{r}
# Modern data

# Confined/unconfined and artesian by aquifer unit

summary_mod_final_art <- modern_constrained %>% 
  group_by(Aquifer_1, artesian) %>% 
  count(Aquifer_1)

# Pivot wider 

mod_final_wide <- pivot_wider(summary_mod_final_art, 
                          names_from = artesian,  
                          values_from = n) %>% 
  rename(art_1 = 3) %>% 
  mutate(total_n = rowSums(across(where(is.numeric)), na.rm = T)) %>% 
  rowwise() %>% 
  mutate(per_art = (art_1/ total_n) *100)

# Tidy the table 

mod_final_table <- mod_final_wide %>% 
  select(Aquifer_1, total_n, art_1, per_art, 2) %>% 
  replace(is.na(.), 0) %>% 
  mutate_if(is.numeric, round, digits = 2) %>% 
  unite(artesian_wells, c("art_1", "per_art"), sep = "  |  ") %>% 
  rename("Aquifer Systems" = "Aquifer_1", 
         "N wells" = "total_n",  
         "Artesian confined flowing wells" = "artesian_wells",
         "Not artesian" = "0") 


# Write to file 
write_csv(mod_final_table, here::here("output_data", "depths", "mod_final_table.txt"))
  
```

```{r echo = FALSE, results = 'asis'}

# Display knitted table 

kable(mod_final_table, caption = "Table 1. Modern (2010-2021) confined and artesian wells of the continental USA")
```

##### 1900s Data 

```{r}
# 1900s data

summary_1900_final_art <- historical_constrained %>% 
  group_by(Aquifer_1, artesian) %>% 
  count(Aquifer_1)

# Pivot wider 

historical_final_wide <- pivot_wider(summary_1900_final_art, 
                          names_from = artesian,  
                          values_from = n) %>% 
  rename(art_1 = 3) %>% 
  mutate(total_n = rowSums(across(where(is.numeric)), na.rm = T)) %>% 
  rowwise() %>% 
  mutate(per_art = (art_1/ total_n) *100)

# Tidy the table 

historical_final_table <- historical_final_wide %>% 
  select(Aquifer_1, total_n, art_1, per_art, 2) %>% 
  replace(is.na(.), 0) %>% 
  mutate_if(is.numeric, round, digits = 2) %>% 
  unite(artesian_wells, c("art_1", "per_art"), sep = "  |  ") %>% 
  rename("Aquifer Systems" = "Aquifer_1", 
         "N wells" = "total_n",  
         "Artesian confined flowing wells" = "artesian_wells",
         "Not artesian" = "0")  

# Write to file 
write_csv(historical_final_table, here::here("output_data", "depths", "early1900s_final_table.txt"))

```


```{r echo = FALSE, results = 'asis'}

# Display knitted table 

kable(historical_final_table, caption = "Table 2. Early 1900s confined and artesian wells of the continental USA")
```
## Other figure 

```{r}
joined <- historical_final_wide %>% 
  inner_join(mod_final_wide, by = "Aquifer_1") %>% 
  select(Aquifer_1, total_n.x, art_1.x, total_n.y, art_1.y) %>% 
  mutate("Historical Fraction" = art_1.x/total_n.x) %>% 
  mutate("Modern Fraction" = art_1.y/total_n.y) %>% 
  rename("Aquifer" = "Aquifer_1", 
         "Historical N" = "total_n.x", 
         "Historical Artesian N" = "art_1.x", 
         "Modern N" = "total_n.y", 
         "Modern Artesian N" = "art_1.y") %>% 
  replace(is.na(.), 0)


write_tsv(joined, here::here("output_data", "depths", "joined_fractions_060722.txt"))
```

Individual Systems  

```{r}
# ME 

me <- joined %>% 
  filter(Aquifer %in% c("Confined Clayborne Near Jackson", "Central Mississippi Embayment", "Western Mississippi Embayment", "Eastern Mississippi Embayment"))

cv <- joined %>% 
  filter(Aquifer %in% c("Tulare Basin", "San Joaquin Basin", "Sacramento Basin"))

nacp <- joined %>%
  filter(Aquifer %in% c("New Jersey Coastal Plain", "Delmarva Peninsula", "Maryland Western Shores", "North Carolina and Virginia Coastal Plain", "Long Island"))

fl <- joined %>%
  filter(Aquifer %in% c("Doughtery Plain and Marianna Lowlands", "Tifton Upland", "Ocala Uplift", "Eastern Flatwoods Southshores", "Vidalia Upland", "Bacon Terrace", "Lower Coastal Plain", "Sea Island", "Intermediate Aquifer", "Pearl and Chattahoochee Aquifer System"))

tx <- joined %>%
  filter(Aquifer %in% c("Houston-Galveston Area"))

roswell <- joined %>% 
  filter(Aquifer == "Roswell Basin")

cp <- joined %>% 
  filter(Aquifer == "Umatilla Basin and Horse Heaven Hills")

dak <- joined %>% 
  filter(Aquifer %in% c("Eastern Dakota Aquifer", "Dakota Aquifer System"))
```

