---
title: "South Dakota: Modern Well Records (~2010-2020)"
author: "Annette Hilton"
date: "11/17/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# South Dakota Modern Analysis 

## Attach Packages

```{r}
# Attach packages 

library(parzer)
library(Rcpp)
library(tidyverse)
library(here)
library(janitor)
library(purrr)
library(broom)
library(tibble)
library(dplyr)
library(tidyr)
library(ggpubr)
library(data.table)
library(lubridate)


# Disable scientific notation 

options(scipen=999)
```

# Methods 

1. Read in modern data of South Dakota (provided by Jasechko, last download 2016) 
2. Tidy data 
3. Prepare for Arc 

# Read in Data

```{r}
sd_raw <-
    list.files(path = here::here("data", "south_dakota"),
               pattern = "*.csv", 
               full.names = T) %>% 
    map_df(~read_csv(., col_types = cols(.default = "c"))) 

```

```{r}
# Tidy data 

sd_tidy <- sd_raw %>% 
  clean_names() %>% 
  mutate(date = lubridate::mdy(well_comp_date), 
         year = lubridate::year(date)) %>% 
  filter(year >= 2010) %>% 
  filter(!is.na(static_value))
```

Write as tsv to check in Arc data spread 

```{r}
write_tsv(sd_tidy, here::here("output_data", "sd_locations.txt")) 
```


## Read in Data 

Observation Wells From: https://apps.sd.gov/nr69obswell/default.aspx#viewHelp
Pos = artesian 
Neg = below land surface 

```{r}
# Well Readings--water level, dates 

sd_wells_raw <- list.files(path = here::here("data", "south_dakota", "sd_obs_wells", "well_readings"), 
                                             pattern = "*.csv", 
                                             full.names = T) %>% 
                             map_df(~read_csv(., col_types = cols(.default = "c")))

# Metadata--well depth 

sd_depth_raw <- list.files(path = here::here("data", "south_dakota", "sd_obs_wells", "meta_data"), 
                                             pattern = "*.csv", 
                                             full.names = T) %>% 
                             map_df(~read_csv(., col_types = cols(.default = "c")))
```

## Tidy Data 

Join dataframes 

```{r}
# Full join 

sd_join <- sd_wells_raw %>% 
  full_join(sd_depth_raw, by = "Observation Well")

# Tidy data 

sd_full_tidy <- sd_join %>% 
  clean_names() %>% 
  select(-is_manual, -x8, -x14) %>% 
  mutate(date = lubridate::mdy(reading_date), 
         year = year(date)) %>% 
  filter(year >= 2010) %>% 
  filter(!is.na(reading)) %>% 
  filter(!is.na(total_depth))

sd_full_tidy$reading <- as.numeric(sd_full_tidy$reading)

sd_full_med <- sd_full_tidy %>% 
  group_by(observation_well) %>% 
  mutate(median = median(reading)) %>% 
  distinct(observation_well, .keep_all = TRUE) %>% 
  mutate(artesian = ifelse(median >= 0, 1, 0))

```



# ---------------------------------------------------------------------------------------

```{r}
# Read in the full dataset for all well water measurements for the USA 

entire_usa_gw <- readr::read_tsv(here::here("data", "entire_usgs_usa.txt"))
```




# Tidy Data 

- Remove wells without well depth 
- Remove wells with zero depth 
- Remove wells without a water level 
- Keep records only from 2010 and later 
- Calculate median water level for that time period 
- Indicate artesian conditions

```{r}
usgs_modern <- entire_usa_gw %>% 
  filter(!well_depth_va == "NA" | !hole_depth_va == "NA") %>% 
  filter(!well_depth_va == 0.00) %>% 
  filter(!lev_dt == "NA") %>%
  filter(!is.na(lev_va)) %>% 
  filter(level_year >= 2010)
  

usgs_modern_med <- usgs_modern %>% 
  group_by(site_no) %>% 
  mutate(median = median(lev_va)) %>% 
  distinct(site_no, .keep_all = TRUE) %>% 
  mutate(artesian = ifelse(lev_va <= 0, 1, 0))

usgs_modern_med$site_no <- sub("^", "w", usgs_modern_med$site_no)

write_tsv(usgs_modern_med, here::here("output_data", "usgs_modern.txt"))
```




