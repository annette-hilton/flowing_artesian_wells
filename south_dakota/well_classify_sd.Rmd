---
title: "South Dakota Project--Well Classification"
author: "Annette Hilton"
date: "05/13/2022"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, error = FALSE)
```

# Introduction

This project is an examination of early 1900s (~1890-1906) groundwater conditions in the Dakota Aquifer System as compared to present day (2010-2021).

The purpose of this Rmd is to: 

*Pre-Rmd*: Data were processed in ArcGIS for DEM value 

1) Prep data for input to ArcGIS (for hydrogeological analysis) 
2) After ArcGIS processing: 

1) Determine well-aquifer classification 
2) Compare artesian conditions 
  

## Attach Packages and Data 

```{r}
# Attach packages 

library(plyr) # Be sure to load `plyr()` first, otherwise other functions in tidyverse break! 
library(tidyverse)
library(here)
library(janitor)
library(naniar)
library(knitr)

# Disable scientific notation 

options(scipen=999)
```

# Overview of Dakota Aquifer System   

```{r, fig.cap= 'Figure 1. Dakota Aquifer System aerial extent (Bredehoeft et al., 1983)', fig.align='center', output.width= "200px", echo= FALSE}

knitr::include_graphics(here::here("images", "sd_aerial.png"))

```

```{r, fig.cap= 'Figure 2. Dakota Aquifer System cross-section (Bredehoeft et al., 1983)', fig.align='center', output.width= "200px", echo= FALSE}

knitr::include_graphics(here::here("images", "sd_cross_section.png"))

```

## ArcGIS Data Analysis

The following steps were performed in ArcGIS:

Hydrogeological data: Arcfile = "cv_classify" (ArcPro)

1. Hydrogeologic layers (top and bottom) of Dakota aquifer (as created by Annette Hilton and Dr. Scott Jasechko; lithological logs) 
2.  Modern wells (USGS & SD Observation wells) (processed in Rmd `modern_data_cleaning.Rmd`) and early 1900s data (early1900s_dem_wgs84_final.txt)
3.  Use tool "Extract multi values to points" to determine well location intersection with geological raster layers
4.  Export resulting well data as a text files

## Data Analysis (Post-Arc)

### Hydrogeological data

```{r}
# Read in modern data file from Arc 

na_values <- c("-9999", "-9999.0000000", "NA")

sd_mod_fromarc <- readr::read_csv(here::here("data", "south_dakota", "sd_mod_classify.txt"), na = na_values) %>% 
  clean_names()
  

# Read in early 1900s data file from Arc 

early1900s_fromarc <- readr::read_csv(here::here("data", "south_dakota", "sd_1900_classify.txt"), na = na_values) %>% 
  clean_names()

```

### SD Aquifer Information 

Hydrologic Model Layer Surfaces:

- Dakota (Top) 
- Dakota (Bottom) 


### Aquifer analysis 

- Find well bottom 
- Remove observations that do not fall within aquifer system (all NAs) 

```{r}
# Convert `rastervalu` column from meters to feet (conversion: 1 meter = 3.28084 feet)
# Add a column that is elevation minus well depth
# Add a column that is elevation minus well water level 

# Modern data 

sd_analysis_mod <- sd_mod_fromarc %>% 
  mutate(topo_ft = rastervalu * 3.28084) %>% 
  mutate(well_bottom = topo_ft - well_depth_va) %>% 
   mutate(keep = 
           ifelse(is.na(dakota_top_nnidw) & is.na(dakota_bottom_nnidw), "NA", "keep")) %>% 
  filter(!keep == "NA")

 
# 1900 data 

sd_analysis_1900 <- early1900s_fromarc %>% 
  mutate(topo_ft = ned10m_bilinear_cusa_albers102003 * 3.28084) %>% 
  mutate(well_bottom = topo_ft - well_depth_ft) %>% 
  mutate(keep = 
           ifelse(is.na(dakota_top_nnidw) & is.na(dakota_bottom_nnidw), "NA", "keep")) %>% 
  filter(!keep == "NA")

```

#### Classify each well to an aquifer unit 

Theory: 

well bottom < top of Dakota = confined aquifer unit (in the Dakota) 


Top Only Analysis 

```{r}
# Classify wells as falling into the Dakota, or not 

# Modern data 

sd_class_mod <- sd_analysis_mod %>% 
  rowwise() %>%
  mutate(aquifer = 
        ifelse(well_bottom <= dakota_top_nnidw, "dakota",
        ifelse(well_bottom < topo_ft & well_bottom > dakota_top_nnidw, "unconfined", NA)))

# 1900 data 

sd_class_1900 <- sd_analysis_1900 %>% 
  rowwise() %>%
  mutate(aquifer = 
        ifelse(well_bottom <= dakota_top_nnidw, "dakota", 
        ifelse(well_bottom < topo_ft & well_bottom > dakota_top_nnidw, "unconfined", NA)))

```

Summary of wells per aquifer unit 

```{r}
# Summary of wells per aquifer unit 

# Modern data 
summarymod_sd <- sd_class_mod %>% 
  group_by(aquifer) %>% 
  count(aquifer) 

# 1900s data 

summary1900_sd <- sd_class_1900 %>% 
  group_by(aquifer) %>% 
  count(aquifer)

```

### Separate each aquifer/unit and confined

#### Modern Data

Confined = Dakota formation **we need a confining condition ? 

```{r}
# Confining unit criteria 

confined_criteria_mod <- sd_class_mod %>% 
  rowwise() %>% 
  mutate(status = 
           case_when(aquifer == "unconfined" ~"unconfined", 
                     aquifer == "dakota" ~"confined", TRUE ~"NA"))

```

#### 1900 Data

Just confining unit above

```{r}
# Confining unit criteria 

confined_criteria_1900 <- sd_class_1900 %>% 
  rowwise() %>% 
  mutate(status = 
           case_when(aquifer == "unconfined" ~"unconfined", 
                     aquifer == "dakota" ~"confined", TRUE ~"NA"))

```

### Accuracy check with USGS Confined/Unconfined 

#### Modern data only 

```{r}

sd_modern_check <- confined_criteria_mod %>% 
  rowwise() %>% 
  mutate(check =
           ifelse(is.na(status) & code %in% c("Confined single aquifer", "Confined multiple aquifers"), "only_usgs_data_c", 
           ifelse(is.na(status) & code %in% c("Unconfined single aquifer", "Unconfined multiple aquifer"), "only_usgs_data_uc",
           ifelse(status == "confined" & code %in% c("Confined single aquifer", "Confined multiple aquifers"), "true_c", 
           ifelse(status == "confined" & is.na(code), "no_data_c", 
           ifelse(status == "confined" & code %in% c("Unconfined single aquifer", "Unconfined multiple aquifer"), "wrong_c", 
           ifelse(status == "unconfined" & is.na(code), "no_data_uc",
           ifelse(status == "unconfined" & code %in% c("Unconfined single aquifer", "Unconfined multiple aquifer"), "true_uc", 
           ifelse(status == "unconfined" & code %in% c("Confined single aquifer", "Confined multiple aquifers"), "wrong_uc", 
            NA)))))))))

summary_check <- sd_modern_check %>% 
  group_by(check) %>% 
  count(check)
```

### Make summary tables 

To count confined, unconfined, artesian by aquifer unit 

Make nice final table

#### Modern Data 

```{r}
# Final summaries of "correct" data 

# Modern data

# Confined/unconfined and artesian by aquifer unit

summary_mod_final_art <- sd_modern_check %>% 
  filter(!check %in% c("wrong_uc", "wrong_c"), 
         !is.na(check)) %>% 
  group_by(status, artesian) %>% 
  count(aquifer) 

# Pivot wider 

mod_final_wide <- pivot_wider(summary_mod_final_art, 
                          names_from = c(status, artesian), 
                          values_from = n) %>% 
  mutate(total_n = rowSums(across(where(is.numeric)), na.rm = T)) %>% 
  mutate(total_c = sum(c(confined_0, confined_1), na.rm = T)) %>% 
  rowwise() %>% 
  mutate(per_c = (total_c / total_n) *100) %>% 
  mutate(per_art = (confined_1 / total_c) *100)

# Tidy the table 

mod_final_table <- mod_final_wide %>% 
  select(aquifer, total_n, total_c, per_c, confined_1, per_art, confined_0) %>% 
  filter(aquifer == "dakota") %>% 
  replace(is.na(.), 0) %>% 
  mutate_if(is.numeric, round, digits = 2) %>% 
  unite(confined_wells, c("total_c", "per_c"), sep = "  |  ") %>% 
  unite(artesian_wells, c("confined_1", "per_art"), sep = "  |  ") %>% 
  rename("Aquifer Units" = "aquifer", 
         "N wells" = "total_n", 
         "Number of wells defined as confined" = "confined_wells", 
         "Artesian confined flowing wells" = "artesian_wells",
         "Not artesian" = "confined_0") 


# Write to file 
write_csv(mod_final_table, here::here("output_data", "sd", "mod_final_table.txt"))
  
```


```{r echo = FALSE, results = 'asis'}

# Display knitted table 

kable(mod_final_table, caption = "Table 1. Modern (2010-2021) confined and artesian wells of the Dakota Aquifer System")
```
 
#### 1900s Data 

```{r}
# 1900s data

# Confined/unconfined by aquifer unit 
summary_1900_final <- confined_criteria_1900 %>% 
  group_by(status, artesian) %>% 
  count(aquifer) 

# Pivot wider 

early1900s_final_wide <- pivot_wider(summary_1900_final, 
                          names_from = c(status, artesian), 
                          values_from = n) %>% 
  mutate(total_n = rowSums(across(where(is.numeric)), na.rm = T)) %>% 
  rowwise() %>% 
  mutate(total_c = sum(c(confined_0, confined_1), na.rm = T)) %>% 
  mutate(per_c = (total_c / total_n) *100) %>% 
  mutate(per_art = (confined_1 / total_c) *100)

# Tidy the table 

early1900s_final_table <- early1900s_final_wide %>% 
  filter(aquifer == "dakota") %>% 
  select(total_n, total_c, per_c, confined_1, per_art, confined_0) %>% 
  replace(is.na(.), 0) %>% 
  mutate_if(is.numeric, round, digits = 2) %>% 
  unite(confined_wells, c("total_c", "per_c"), sep = "  |  ") %>% 
  unite(artesian_wells, c("confined_1", "per_art"), sep = "  |  ") %>% 
  rename("N wells" = "total_n", 
         "Number of wells defined as confined" = "confined_wells", 
         "Artesian confined flowing wells" = "artesian_wells",
         "Not artesian" = "confined_0") 

# Write to file 
write_csv(early1900s_final_table, here::here("output_data", "sd", "early1900s_final_table.txt"))

```

```{r echo = FALSE, results = 'asis'}

# Display knitted table 

kable(early1900s_final_table, caption = "Table 1. Early 1900s confined and artesian wells of the Dakota Aquifer System")
```

Fraction of confined wells to depth 

```{r}
# Data frame for plots 
ggplot_modern <- sd_modern_check %>% 
  filter(!check %in% c("wrong_c", "wrong_uc")) %>% 
  filter(!is.na(check))

# Violin plot comparing confined, unconfined and USGS data/no data 
ggplot(ggplot_modern, 
       aes(x = aquifer, 
           y = well_depth_va, 
           fill = check)) + 
  geom_violin()

```

#### Comparison of artesian conditions (confined wells only) 

1900 to 2010-2020


```{r}
# All aquifers that are confined by our criteria, excluding "incorrect" ones (Modern) with USGS correction 

# Modern wells 
sd_confined_mod <- sd_modern_check %>% 
  filter(check %in% c("true_c", "no_data_c")) 

# Write as tsv 
write_csv(sd_confined_mod, here::here("output_data", "sd", "sd_confined_mod.txt"))

# 1900 data 
sd_confined_1900 <- confined_criteria_1900 %>% 
  filter(status == "confined") 

# Write as tsv 
write_csv(sd_confined_1900, here::here("output_data", "sd", "sd_confined_historical.txt"))

```

Final summary table of artesian conditions (percentage of flowing artesian wells) 

```{r}
# Modern 
mod_art <- sd_confined_mod %>% 
  count(artesian) 


# Historical 
hist_art <- sd_confined_1900 %>% 
  count(artesian)
```

